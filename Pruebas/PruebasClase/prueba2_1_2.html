<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba 2.1-2 - Y tu quien eres</title>
    <link rel="stylesheet" href="../../styles.css">
    <style>
        body {
            background: url('../../Assets/PruebaAccederAlCurso.jpg');
            overflow-x: hidden; 
            overflow-y: auto;   
            overflow: auto;
        }

        .game-container {
            max-width: 900px;
            background: rgba(240, 240, 240, 0.8);
        }
        
        .header {
            margin-bottom: 0;
        }

    </style>
</head>
<body>
    <div class="intro-overlay" id="introOverlay">
        <div class="intro-dialogue">
            <div class="intro-text">
                Te llega un correo de un alumno (ladysman217@universidad.es) preguntándote por qué le has puesto un suspenso.<br><br>
                
                Revisas la lista de asistencia y ves que no ha asistido más que a la clase de presentación de la asignatura. De hecho, no ha llegado a abrir la asignatura en el portal digital. Espera, ¿entonces cómo ha podido ver la nota...?<br><br>
                
                Bueno, da igual. Le respondes lo que esperas que sea un amable correo explicándole que tú has tenido que evaluar siguiendo los criterios que ha dejado escritos el profesor anterior, que no puedes hacer mucho más por ayudarle (principalmente porque no sabes ni quién es, pero esto no lo dices en el correo).
            </div>
            <button class="continue-btn" onclick="closeIntro()">Continuar</button>
        </div>
    </div>

    <div class="game-wrapper">
        <button class="back-btn" onclick="goBack()">← Volver a Clase</button>

        <div class="game-container">
            <div class="header">
                <h1>Y TÚ QUIÉN ERES</h1>
                <p>Sigue el ritmo para escribir el correo</p>
            </div>

            <div class="content">
                <div class="instruction">
                    <strong>INSTRUCCIONES:</strong><br>
                    1. Observa la secuencia de ritmos (la primera nota es blanca, es la REFERENCIA)<br>
                    2. Cuando termine, reproduce el ritmo completo presionando ESPACIO<br>
                    3. Si aciertas el ritmo completo, se revela la frase entera<br>
                    4. Si fallas, debes repetir la secuencia
                </div>

                <div class="email-preview" id="emailPreview">
                    <div id="emailContent"></div>
                </div>

                <div class="rhythm-game">
                    <div class="status-bar">
                        <div class="progress-info">
                            <span>Frase: <span id="phraseNum">1</span>/5</span>
                            <span style="margin-left: 2rem;">Palabras en frase: <span id="wordNum">0</span></span>
                        </div>
                        <div id="statusMessage">Prepárate...</div>
                    </div>

                    <div class="beat-display" id="beatDisplay"></div>

                    <div class="controls">
                        <button class="rhythm-btn" id="spaceBtn" onclick="playerBeat()" disabled>
                            ESPACIO
                        </button>
                    </div>

                    <div id="message" class="message hidden"></div>
                </div>

                <button class="complete-btn hidden" id="completeBtn" onclick="completeAndGoBack()">Completado - Volver a Clase</button>
            </div>
        </div>
    </div>

    <script>
        const emailPhrases = [
            ["Estimado", "alumno"],
            ["Siento", "comunicarte", "que"],
            ["tu", "nota", "se"],
            ["debe", "a", "tu"],
            ["cantidad", "de", "ausencias"]
        ];

        const rhythmPatterns = [
            [600, 600],
            [500, 700, 500],
            [400, 400, 600],
            [500, 600, 600],
            [400, 500, 700]
        ];

        let currentPhrase = 0;
        let isPlaying = false;
        let isPlayerTurn = false;
        let playerSequence = [];
        let expectedSequence = [];
        let startTime = 0;
        let wordsRevealed = [];
        let waitingForInput = false;
        const TOLERANCE = 450;

        function initGame() {
            wordsRevealed = emailPhrases.map(phrase => phrase.map(() => ({ revealed: false, crossed: false })));
            renderEmail();
            startPhrase();
        }

        function renderEmail() {
            const content = document.getElementById('emailContent');
            content.innerHTML = '';

            emailPhrases.forEach((phrase, pIdx) => {
                phrase.forEach((word, wIdx) => {
                    const wordSpan = document.createElement('span');
                    wordSpan.className = 'word';
                    
                    if (wordsRevealed[pIdx][wIdx].revealed) {
                        wordSpan.textContent = word;
                        wordSpan.classList.add('revealed');
                    } else {
                        wordSpan.textContent = '_'.repeat(word.length);
                    }
                    
                    if (wordsRevealed[pIdx][wIdx].crossed) {
                        wordSpan.classList.add('crossed');
                    }
                    
                    content.appendChild(wordSpan);
                });
                content.appendChild(document.createElement('br'));
            });
        }

        function startPhrase() {
            document.getElementById('phraseNum').textContent = currentPhrase + 1;
            document.getElementById('wordNum').textContent = emailPhrases[currentPhrase].length;
            showMessage('Observa la secuencia...', 'info');
            
            setTimeout(() => {
                playSequence();
            }, 1500);
        }

        function playSequence() {
            isPlaying = true;
            waitingForInput = false;
            document.getElementById('spaceBtn').disabled = true;
            const pattern = rhythmPatterns[currentPhrase];
            const beatDisplay = document.getElementById('beatDisplay');
            beatDisplay.innerHTML = '';

            const refBeat = document.createElement('div');
            refBeat.className = 'beat reference';
            refBeat.innerHTML = '♪<div class="beat-label">REF</div>';
            beatDisplay.appendChild(refBeat);

            for (let i = 0; i < pattern.length; i++) {
                const beat = document.createElement('div');
                beat.className = 'beat';
                beat.innerHTML = `♪<div class="beat-label">${i + 1}</div>`;
                beatDisplay.appendChild(beat);
            }

            const beats = beatDisplay.querySelectorAll('.beat');
            let currentBeat = 0;

            function activateNextBeat() {
                if (currentBeat > 0) {
                    beats[currentBeat - 1].classList.remove('active');
                }

                if (currentBeat < beats.length) {
                    beats[currentBeat].classList.add('active');
                    const nextDelay = currentBeat === 0 ? pattern[0] : pattern[currentBeat - 1];
                    currentBeat++;
                    setTimeout(activateNextBeat, nextDelay);
                } else {
                    setTimeout(() => {
                        beats[beats.length - 1].classList.remove('active');
                        startPlayerTurn();
                    }, 300);
                }
            }

            activateNextBeat();
        }

        function startPlayerTurn() {
            isPlaying = false;
            isPlayerTurn = true;
            waitingForInput = false;
            playerSequence = [];
            expectedSequence = rhythmPatterns[currentPhrase];
            
            document.getElementById('spaceBtn').disabled = false;
            document.getElementById('statusMessage').textContent = 'Tu turno - Presiona ESPACIO';
            showMessage('Presiona ESPACIO siguiendo el ritmo', 'info');
            
            const beatDisplay = document.getElementById('beatDisplay');
            const beats = Array.from(beatDisplay.querySelectorAll('.beat'));
            
            setTimeout(() => {
                beats[0].classList.add('active');
                setTimeout(() => {
                    beats[0].classList.remove('active');
                    waitingForInput = true;
                    startTime = Date.now();
                }, 200);
            }, 500);
        }

        function playerBeat() {
            if (!isPlayerTurn || !waitingForInput) return;

            const currentTime = Date.now();
            const timeSinceStart = currentTime - startTime;
            playerSequence.push(timeSinceStart);

            const beatDisplay = document.getElementById('beatDisplay');
            const beats = Array.from(beatDisplay.querySelectorAll('.beat'));
            const beatIndex = playerSequence.length;

            if (beatIndex < beats.length) {
                beats[beatIndex].classList.add('active');
                setTimeout(() => {
                    beats[beatIndex].classList.remove('active');
                }, 200);
            }

            if (playerSequence.length === expectedSequence.length) {
                waitingForInput = false;
                checkRhythm();
            }
        }

        function checkRhythm() {
            isPlayerTurn = false;
            document.getElementById('spaceBtn').disabled = true;

            let correct = true;
            const beatDisplay = document.getElementById('beatDisplay');
            const beats = beatDisplay.querySelectorAll('.beat');
            
            let cumulativeExpected = 0;
            for (let i = 0; i < expectedSequence.length; i++) {
                cumulativeExpected += expectedSequence[i];
                const actual = playerSequence[i];
                const diff = Math.abs(cumulativeExpected - actual);

                if (diff > TOLERANCE) {
                    correct = false;
                    beats[i + 1].classList.add('fail');
                } else {
                    beats[i + 1].classList.add('success');
                }
            }

            setTimeout(() => {
                if (correct) {
                    handleSuccess();
                } else {
                    handleFailure();
                }
            }, 1000);
        }

        function handleSuccess() {
            for (let i = 0; i < emailPhrases[currentPhrase].length; i++) {
                wordsRevealed[currentPhrase][i].revealed = true;
                wordsRevealed[currentPhrase][i].crossed = false;
            }
            
            renderEmail();
            showMessage('✓ Correcto - Frase completada', 'success', true);

            currentPhrase++;
            
            if (currentPhrase >= 5) {
                setTimeout(() => {
                    showMessage('¡Has completado el correo!', 'success', true);
                    document.getElementById('completeBtn').classList.remove('hidden');
                    document.querySelector('.rhythm-game').style.display = 'none';
                    localStorage.setItem('prueba2_1_2_completed', 'true');
                }, 1000);
            } else {
                setTimeout(() => {
                    startPhrase();
                }, 2000);
            }
        }

        function handleFailure() {
            for (let i = 0; i < emailPhrases[currentPhrase].length; i++) {
                wordsRevealed[currentPhrase][i].crossed = true;
                wordsRevealed[currentPhrase][i].revealed = false;
            }
            
            renderEmail();
            showMessage('Fallaste el ritmo. Inténtalo de nuevo', 'error');

            setTimeout(() => {
                for (let i = 0; i < emailPhrases[currentPhrase].length; i++) {
                    wordsRevealed[currentPhrase][i].crossed = false;
                }
                renderEmail();
                playSequence();
            }, 2000);
        }

        function showMessage(text, type, persistent = false) {
            const msg = document.getElementById('message');
            const status = document.getElementById('statusMessage');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.classList.remove('hidden');
            status.textContent = text;
            
            if (!persistent && (type === 'error' || type === 'info')) {
                setTimeout(() => {
                    msg.classList.add('hidden');
                }, 3000);
            }
        }

        document.addEventListener('keydown', (e) => {
            if ((e.code === 'Space' || e.key === ' ') && isPlayerTurn && waitingForInput) {
                e.preventDefault();
                playerBeat();
            }
        });

        function closeIntro() {
            const overlay = document.getElementById('introOverlay');
            overlay.style.animation = 'fadeOut 0.5s';
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 500);
        }

        function goBack() {
            window.location.href = '../../Escenarios/clase.html';
        }

        function completeAndGoBack() {
            localStorage.setItem('prueba2_1_2_completed', 'true');
            window.location.href = '../../Escenarios/clase.html';
        }

        initGame();
    </script>
</body>
</html>