<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba 2.1-2 - Y tu quien eres</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <div class="intro-overlay" id="introOverlay">
        <div class="intro-dialogue">
            <div class="intro-text">
                Te llega un correo de un alumno (ladysman217@universidad.es) preguntandote porque le has puesto un suspenso.<br><br>
                
                Revisas la lista de asistencia y ves que no ha asistido a mas que la clase de presentacion de la asignatura. De hecho, no ha llegado a abrir la asignatura en el portal digital. Espera, entonces como ha podido ver la nota...?<br><br>
                
                Bueno, da igual. Le respondes lo que esperas que sea un amable correo explicandole que tu has tenido que evaluar siguiendo los criterios que ha dejado escritos el profesor anterior, que no puedes hacer mucho mas por ayudarle (principalmente porque no sabes ni quien es, pero esto no lo dices en el correo).
            </div>
            <button class="continue-btn" onclick="closeIntro()">Continuar</button>
        </div>
    </div>

    <div class="game-wrapper">
        <button class="back-btn" onclick="goBack()">Volver a Clase</button>

        <div class="game-container">
            <div class="header">
                <h1>Y TU QUIEN ERES</h1>
                <p>Sigue el ritmo para escribir el correo</p>
            </div>

            <div class="content">
                <div class="instruction">
                    <strong>INSTRUCCIONES:</strong><br>
                    1. Observa la secuencia de ritmos (la primera nota es blanca, es la REFERENCIA)<br>
                    2. Cuando termine, reproduce el ritmo completo presionando ESPACIO<br>
                    3. Si aciertas el ritmo completo, se revela la frase entera<br>
                    4. Si fallas, debes repetir la secuencia
                </div>

                <div class="email-preview" id="emailPreview">
                    <div id="emailContent"></div>
                </div>

                <div class="rhythm-game">
                    <div class="status-bar">
                        <div class="progress-info">
                            <span>Frase: <span id="phraseNum">1</span>/5</span>
                            <span style="margin-left: 2rem;">Palabras en frase: <span id="wordNum">0</span></span>
                        </div>
                        <div id="statusMessage">Preparate...</div>
                    </div>

                    <div class="beat-display" id="beatDisplay"></div>

                    <div class="controls">
                        <button class="rhythm-btn" id="spaceBtn" onclick="playerBeat()" disabled>
                            ESPACIO
                        </button>
                    </div>

                    <div id="message" class="message hidden"></div>
                </div>

                <button class="complete-btn hidden" id="completeBtn" onclick="completeAndGoBack()">Completado - Volver a Clase</button>
            </div>
        </div>
    </div>

    <script>
        const emailPhrases = [
            ["Estimado", "alumno"],
            ["Gracias", "por", "tu"],
            ["He", "revisado", "los"],
            ["La", "calificacion", "se"],
            ["en", "criterios", "anteriores"]
        ];

        const rhythmPatterns = [
            [600, 600],                    // Frase 1: 2 palabras = 2 notas usuario
            [500, 700, 500],               // Frase 2: 3 palabras = 3 notas usuario
            [400, 400, 600],               // Frase 3: 3 palabras = 3 notas usuario
            [500, 600, 600],               // Frase 4: 3 palabras = 3 notas usuario
            [400, 500, 700]                // Frase 5: 3 palabras = 3 notas usuario
        ];

        let currentPhrase = 0;
        let currentWord = 0;
        let isPlaying = false;
        let isPlayerTurn = false;
        let playerSequence = [];
        let expectedSequence = [];
        let startTime = 0;
        let wordsRevealed = [];
        let waitingForInput = false;
        const TOLERANCE = 450; // 300% más tolerancia (era 150ms)

        function initGame() {
            wordsRevealed = emailPhrases.map(phrase => phrase.map(() => ({ revealed: false, crossed: false })));
            renderEmail();
            startPhrase();
        }

        function renderEmail() {
            const content = document.getElementById('emailContent');
            content.innerHTML = '';

            emailPhrases.forEach((phrase, pIdx) => {
                phrase.forEach((word, wIdx) => {
                    const wordSpan = document.createElement('span');
                    wordSpan.className = 'word';
                    
                    if (wordsRevealed[pIdx][wIdx].revealed) {
                        wordSpan.textContent = word;
                        wordSpan.classList.add('revealed');
                    } else {
                        wordSpan.textContent = '_'.repeat(word.length);
                    }
                    
                    if (wordsRevealed[pIdx][wIdx].crossed) {
                        wordSpan.classList.add('crossed');
                    }
                    
                    content.appendChild(wordSpan);
                });
                content.appendChild(document.createElement('br'));
            });
        }

        function startPhrase() {
            currentWord = 0;
            document.getElementById('phraseNum').textContent = currentPhrase + 1;
            document.getElementById('totalWords').textContent = emailPhrases[currentPhrase].length;
            updateWordCount();
            showMessage('Observa la secuencia...', 'info');
            
            setTimeout(() => {
                playSequence();
            }, 1500);
        }

        function playSequence() {
            isPlaying = true;
            waitingForInput = false;
            document.getElementById('spaceBtn').disabled = true;
            const pattern = rhythmPatterns[currentPhrase];
            const beatDisplay = document.getElementById('beatDisplay');
            beatDisplay.innerHTML = '';

            // Crear beats: 1 referencia + las necesarias para el patrón
            const refBeat = document.createElement('div');
            refBeat.className = 'beat reference';
            refBeat.innerHTML = '♪<div class="beat-label">REF</div>';
            beatDisplay.appendChild(refBeat);

            for (let i = 0; i < pattern.length; i++) {
                const beat = document.createElement('div');
                beat.className = 'beat';
                beat.innerHTML = `♪<div class="beat-label">${i + 1}</div>`;
                beatDisplay.appendChild(beat);
            }

            const beats = beatDisplay.querySelectorAll('.beat');
            let currentBeat = 0;

            function activateNextBeat() {
                if (currentBeat > 0) {
                    beats[currentBeat - 1].classList.remove('active');
                }

                if (currentBeat < beats.length) {
                    beats[currentBeat].classList.add('active');
                    
                    // La nota de referencia también tiene un timing (primer intervalo del patrón)
                    const nextDelay = currentBeat === 0 ? pattern[0] : pattern[currentBeat - 1];
                    currentBeat++;
                    
                    setTimeout(activateNextBeat, nextDelay);
                } else {
                    setTimeout(() => {
                        beats[beats.length - 1].classList.remove('active');
                        startPlayerTurn();
                    }, 300);
                }
            }

            activateNextBeat();
        }

        function startPlayerTurn() {
            isPlaying = false;
            isPlayerTurn = true;
            waitingForInput = false;
            playerSequence = [];
            expectedSequence = rhythmPatterns[currentPhrase];
            
            document.getElementById('spaceBtn').disabled = false;
            document.getElementById('statusMessage').textContent = 'Tu turno - Presiona ESPACIO';
            showMessage('Presiona ESPACIO siguiendo el ritmo', 'info');
            
            // Iluminar la nota blanca automáticamente al inicio del turno del jugador
            const beatDisplay = document.getElementById('beatDisplay');
            const beats = Array.from(beatDisplay.querySelectorAll('.beat'));
            
            setTimeout(() => {
                beats[0].classList.add('active');
                setTimeout(() => {
                    beats[0].classList.remove('active');
                    // Ahora sí puede empezar a presionar
                    waitingForInput = true;
                    startTime = Date.now(); // Establecer el tiempo de inicio después de la referencia
                }, 200);
            }, 500); // Pequeña pausa antes de mostrar la referencia
        }

        function playerBeat() {
            if (!isPlayerTurn || !waitingForInput) return;

            const currentTime = Date.now();
            
            // Calcular tiempo desde el inicio (que se estableció después de la nota blanca)
            const timeSinceStart = currentTime - startTime;
            playerSequence.push(timeSinceStart);

            const beatDisplay = document.getElementById('beatDisplay');
            const beats = Array.from(beatDisplay.querySelectorAll('.beat'));
            const beatIndex = playerSequence.length; // 1, 2, 3...

            // Activar el beat correspondiente (saltando la referencia que es 0)
            if (beatIndex < beats.length) {
                beats[beatIndex].classList.add('active');
                setTimeout(() => {
                    beats[beatIndex].classList.remove('active');
                }, 200);
            }

            // Si completamos todas las notas necesarias
            if (playerSequence.length === expectedSequence.length) {
                waitingForInput = false;
                checkRhythm();
            }
        }

        function checkRhythm() {
            isPlayerTurn = false;
            document.getElementById('spaceBtn').disabled = true;

            let correct = true;
            const beatDisplay = document.getElementById('beatDisplay');
            const beats = beatDisplay.querySelectorAll('.beat');

            // Comparar los tiempos de pulsación con el patrón esperado
            // playerSequence tiene los tiempos absolutos desde startTime
            // expectedSequence tiene los intervalos esperados
            
            let cumulativeExpected = 0;
            for (let i = 0; i < expectedSequence.length; i++) {
                cumulativeExpected += expectedSequence[i];
                const actual = playerSequence[i];
                const diff = Math.abs(cumulativeExpected - actual);

                if (diff > TOLERANCE) {
                    correct = false;
                    beats[i + 1].classList.add('fail');
                } else {
                    beats[i + 1].classList.add('success');
                }
            }

            setTimeout(() => {
                if (correct) {
                    handleSuccess();
                } else {
                    handleFailure();
                }
            }, 1000);
        }

        function handleSuccess() {
            // Revelar TODAS las palabras de la frase actual
            for (let i = 0; i < emailPhrases[currentPhrase].length; i++) {
                wordsRevealed[currentPhrase][i].revealed = true;
                wordsRevealed[currentPhrase][i].crossed = false;
            }
            
            renderEmail();
            showMessage('Correcto - Frase completada', 'success');

            // Pasar a la siguiente frase
            currentPhrase++;
            
            // Si completamos las 5 frases, terminar el juego
            if (currentPhrase >= 5) {
                setTimeout(() => {
                    showMessage('Has completado el correo', 'success');
                    document.getElementById('completeBtn').classList.remove('hidden');
                    document.querySelector('.rhythm-game').style.display = 'none';
                    localStorage.setItem('prueba2_1_2_completed', 'true');
                }, 1000);
            } else {
                // Pasar a la siguiente frase
                setTimeout(() => {
                    startPhrase();
                }, 2000);
            }
        }

        function handleFailure() {
            // Marcar TODAS las palabras de la frase como tachadas
            for (let i = 0; i < emailPhrases[currentPhrase].length; i++) {
                wordsRevealed[currentPhrase][i].crossed = true;
                wordsRevealed[currentPhrase][i].revealed = false;
            }
            
            renderEmail();
            showMessage('Fallaste el ritmo. Intentalo de nuevo', 'error');

            setTimeout(() => {
                // Limpiar las palabras tachadas
                for (let i = 0; i < emailPhrases[currentPhrase].length; i++) {
                    wordsRevealed[currentPhrase][i].crossed = false;
                }
                renderEmail();
                playSequence();
            }, 2000);
        }

        function updateWordCount() {
            document.getElementById('wordNum').textContent = currentWord;
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            const status = document.getElementById('statusMessage');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.classList.remove('hidden');
            status.textContent = text;
            
            setTimeout(() => {
                if (type !== 'success') {
                    msg.classList.add('hidden');
                }
            }, 3000);
        }

        document.addEventListener('keydown', (e) => {
            if ((e.code === 'Space' || e.key === ' ') && isPlayerTurn && waitingForInput) {
                e.preventDefault();
                playerBeat();
            }
        });

        function closeIntro() {
            const overlay = document.getElementById('introOverlay');
            overlay.style.animation = 'fadeOut 0.5s';
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 500);
            
            if (!localStorage.getItem('prueba2_1_2_visited')) {
                localStorage.setItem('prueba2_1_2_visited', 'true');
            }
        }

        function goBack() {
            window.location.href = '../../Escenarios/clase.html';
        }

        function completeAndGoBack() {
            localStorage.setItem('prueba2_1_2_completed', 'true');
            window.location.href = '../../Escenarios/clase.html';
        }

        window.onload = function() {
            if (localStorage.getItem('prueba2_1_2_visited')) {
                closeIntro();
            }
        };

        initGame();
        
        function renderEmail() {
            const content = document.getElementById('emailContent');
            content.innerHTML = '';

            emailPhrases.forEach((phrase, pIdx) => {
                phrase.forEach((word, wIdx) => {
                    const wordSpan = document.createElement('span');
                    wordSpan.className = 'word';
                    
                    if (wordsRevealed[pIdx][wIdx].revealed) {
                        wordSpan.textContent = word;
                        wordSpan.classList.add('revealed');
                    } else {
                        wordSpan.textContent = '_'.repeat(word.length);
                    }
                    
                    if (wordsRevealed[pIdx][wIdx].crossed) {
                        wordSpan.classList.add('crossed');
                    }
                    
                    content.appendChild(wordSpan);
                });
                content.appendChild(document.createElement('br'));
            });
        }
    </script>
</body>
</html>