<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba 1 - Practicas por Corregir</title>
    <link rel="stylesheet" href="../../styles.css">
</head>
<body>
    <button class="back-btn" onclick="goBack()">Volver al Despacho</button>
    
    <div class="overlay"></div>
    <div class="game-container">
        <div class="header">
            <h1>PRACTICAS POR CORREGIR</h1>
            <div class="instructions">
                Los alumnos han entregado un ejercicio de teoria musical... Agrupa las 16 palabras en 4 categorias de 4 palabras cada una.
            </div>
        </div>

        <div class="hint-section">
            <button class="hint-btn" id="hintBtn" onclick="showHint()">Ver Pista</button>
            <div class="hint-text hidden" id="hintText"></div>
        </div>

        <div id="message" class="message hidden"></div>
        
        <div class="attempts">
            Intentos restantes: <strong id="attemptsCount">4</strong>
        </div>

        <div class="solved-groups" id="solvedGroups"></div>

        <div class="words-grid" id="wordsGrid"></div>

        <div class="controls">
            <button onclick="shuffleWords()">Mezclar</button>
            <button onclick="deselectAll()">Deseleccionar</button>
            <button onclick="checkSelection()" id="submitBtn" disabled>Enviar</button>
        </div>

        <button class="complete-btn hidden" id="completeBtn" onclick="completeAndGoBack()">Completado - Volver al Despacho</button>
    </div>

    <script>
        const groups = [
            {
                category: "INSTRUMENTOS MUSICALES",
                words: ["BAJO", "PIANO", "TROMPA", "CLAVE"],
                color: "yellow"
            },
            {
                category: "TEORIA MUSICAL",
                words: ["TONO", "ESCALA", "DODECAFONISMO", "QUINTA"],
                color: "green"
            },
            {
                category: "TEMPO Y RITMO",
                words: ["TEMPO", "COMPAS", "PRESTO", "CANON"],
                color: "blue"
            },
            {
                category: "CARACTERISTICAS DEL SONIDO",
                words: ["TIMBRE", "NOTA", "VOLUMEN", "INTENSIDAD"],
                color: "purple"
            }
        ];

        let allWords = [];
        let selectedWords = [];
        let attempts = 4;
        let solvedGroupsArr = [];
        let hintUsed = false;
        let attemptedCombinations = new Set();

        function initGame() {
            allWords = groups.flatMap(g => g.words.map(w => ({ word: w, group: g.category, color: g.color })));
            shuffleArray(allWords);
            renderWords();
        }

        function showHint() {
            if (hintUsed) return;
            
            hintUsed = true;
            const remainingGroups = groups.filter(g => !solvedGroupsArr.some(sg => sg.category === g.category));
            
            if (remainingGroups.length > 0) {
                const hintGroup = remainingGroups[0];
                const hintText = document.getElementById('hintText');
                hintText.textContent = `Pista: Una categoria es "${hintGroup.category}"`;
                hintText.classList.remove('hidden');
                document.getElementById('hintBtn').disabled = true;
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function renderWords() {
            const grid = document.getElementById('wordsGrid');
            grid.innerHTML = '';
            
            allWords.forEach((item, i) => {
                const card = document.createElement('div');
                card.className = 'word-card';
                card.textContent = item.word;
                card.onclick = () => toggleSelection(i);
                card.id = `word-${i}`;
                grid.appendChild(card);
            });
        }

        function toggleSelection(i) {
            const card = document.getElementById(`word-${i}`);
            if (card.classList.contains('correct')) return;

            const wordObj = allWords[i];
            const idx = selectedWords.findIndex(w => w.index === i);

            if (idx > -1) {
                selectedWords.splice(idx, 1);
                card.classList.remove('selected');
            } else if (selectedWords.length < 4) {
                selectedWords.push({ ...wordObj, index: i });
                card.classList.add('selected');
            }

            document.getElementById('submitBtn').disabled = selectedWords.length !== 4;
        }

        function deselectAll() {
            selectedWords = [];
            document.querySelectorAll('.word-card').forEach(card => {
                if (!card.classList.contains('correct')) {
                    card.classList.remove('selected');
                }
            });
            document.getElementById('submitBtn').disabled = true;
        }

        function shuffleWords() {
            shuffleArray(allWords);
            renderWords();
            
            selectedWords.forEach(sw => {
                const newIdx = allWords.findIndex(w => w.word === sw.word);
                const card = document.getElementById(`word-${newIdx}`);
                if (card) card.classList.add('selected');
            });

            allWords.forEach((w, i) => {
                if (solvedGroupsArr.some(g => g.words.includes(w.word))) {
                    document.getElementById(`word-${i}`).classList.add('correct');
                }
            });
        }

        function checkSelection() {
            if (selectedWords.length !== 4) return;

            const selectedWordsStr = selectedWords.map(w => w.word).sort().join(',');
            
            if (attemptedCombinations.has(selectedWordsStr)) {
                showMessage('Ya has intentado esta combinacion anteriormente.', 'warning');
                deselectAll();
                return;
            }

            attemptedCombinations.add(selectedWordsStr);

            const selectedCategories = [...new Set(selectedWords.map(w => w.group))];

            if (selectedCategories.length === 1) {
                showMessage('Correcto. Has encontrado un grupo.', 'success');
                const group = groups.find(g => g.category === selectedCategories[0]);
                solvedGroupsArr.push(group);
                
                selectedWords.forEach(sw => {
                    document.getElementById(`word-${sw.index}`).classList.add('correct');
                });

                const groupDiv = document.createElement('div');
                groupDiv.className = `group ${group.color}`;
                groupDiv.innerHTML = `<h3>${group.category}</h3><div>${group.words.join(' â€¢ ')}</div>`;
                document.getElementById('solvedGroups').appendChild(groupDiv);

                allWords = allWords.filter(w => !group.words.includes(w.word));
                selectedWords = [];
                
                if (solvedGroupsArr.length === 4) {
                    showMessage('FELICIDADES. Has completado todas las practicas.', 'success');
                    document.getElementById('completeBtn').classList.remove('hidden');
                    document.getElementById('wordsGrid').style.display = 'none';
                    document.querySelector('.controls').style.display = 'none';
                } else {
                    hintUsed = false;
                    document.getElementById('hintBtn').disabled = false;
                    document.getElementById('hintText').classList.add('hidden');
                }

                renderWords();
            } else if (selectedCategories.length === 2) {
                const correctCount = Math.max(
                    selectedWords.filter(w => w.group === selectedCategories[0]).length,
                    selectedWords.filter(w => w.group === selectedCategories[1]).length
                );
                
                if (correctCount === 3) {
                    showMessage(`Te falta una palabra de este conjunto. Tienes ${correctCount} palabras correctas de un grupo.`, 'warning');
                } else {
                    attempts--;
                    document.getElementById('attemptsCount').textContent = attempts;
                    
                    if (attempts === 0) {
                        showMessage('Se acabaron los intentos. Intentalo de nuevo.', 'error');
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showMessage('Incorrecto. Estas palabras no forman un grupo.', 'error');
                    }
                }
                
                deselectAll();
            } else {
                attempts--;
                document.getElementById('attemptsCount').textContent = attempts;
                
                if (attempts === 0) {
                    showMessage('Se acabaron los intentos. Intentalo de nuevo.', 'error');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showMessage('Incorrecto. Estas palabras no forman un grupo.', 'error');
                }
                
                deselectAll();
            }

            document.getElementById('submitBtn').disabled = true;
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.classList.remove('hidden');
            
            setTimeout(() => {
                if (type === 'error' || type === 'warning') {
                    msg.classList.add('hidden');
                }
            }, 3000);
        }

        function goBack() {
            window.location.href = '../../Escenarios/despacho.html';
        }

        function completeAndGoBack() {
            localStorage.setItem('prueba1_completed', 'true');
            window.location.href = '../../Escenarios/despacho.html';
        }

        initGame();
    </script>
</body>
</html>