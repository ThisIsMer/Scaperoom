<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba 3.1-2-3 - Buscar la Cafeteria</title>
    <link rel="stylesheet" href="../../styles.css">
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: url('../../Assets/Pasillo.jpg');
            background-size: cover;
            background-position: center;
            min-height: 100vh;
            overflow-x: hidden; 
            overflow-y: auto;   
            overflow: auto;
        }

    </style>
</head>
<body>
    <button class="back-btn" onclick="goBack()">Volver al Pasillo</button>

    <div class="game-container">
        <div class="header">
            <h1>BUSCANDO LA CAFETERIA</h1>
            <p>La Orquesta sin Obertura ni Intermedio</p>
        </div>

        <div class="content">
            <div class="dialogue">
                Por fin el bendito y tan esperado descanso, después de tantas horas de arduo trabajo <br>
                te apetece un café bien calentito y de calidad, pero… ¿Dónde encontrarlo? <br>
                (No, la máquina expendedora de la esquina no da café de verdad, es atrezo) <br><br>
                Pues nada, tocará buscar dónde está la cafetería. 

            </div>

            <div class="instruction">
                <strong>OBJETIVO:</strong> Debes elegir el instrumento que pueda entrar en la orquesta 5 veces consecutivas.<br>
                Si te equivocas, el contador se reinicia.
            </div>

            <button class="hint-btn" onclick="toggleHint()">Ver Pista</button>
            <div class="hint-box" id="hintBox">
                <strong>PISTA:</strong> Fijate bien en el nombre de la orquesta: <strong>SIN O</strong>bertura <strong> NI I</strong>ntermedio...<br>
            </div>

            <div class="progress" id="progress">
                Instrumentos correctos: <span id="score">0</span> / 5
            </div>

            <div class="choices-container">
                <div class="choice-text" id="choiceText">
                    Que instrumento puede entrar en la orquesta?
                </div>
                
                <div class="instruments" id="instruments">
                </div>
            </div>

            <div id="message" class="message hidden"></div>

            <button class="complete-btn hidden" id="completeBtn" onclick="completeAndGoBack()">Has encontrado la cafeteria - Volver al Pasillo</button>
        </div>
    </div>

    <script>
        const instrumentPairs = [
            { valid: 'FLAUTA', invalid: 'VIOLIN', validIcon: '', invalidIcon: '' },
            { valid: 'TUBA', invalid: 'OBOE', validIcon: '', invalidIcon: '' },
            { valid: 'ARPA', invalid: 'TROMBON', validIcon: '', invalidIcon: '' },
            { valid: 'MARACAS', invalid: 'PIANO', validIcon: '', invalidIcon: '' },
            { valid: 'CLAVE', invalid: 'VIOLONCHELO', validIcon: '', invalidIcon: '' },
            { valid: 'PANDERETA', invalid: 'GUITARRA', validIcon: '', invalidIcon: '' },
            { valid: 'LAUD', invalid: 'SAXOFON', validIcon: '', invalidIcon: '' }
        ];

        let score = 0;
        let usedPairs = [];
        let mistakes = 0;

        function toggleHint() {
            const hintBox = document.getElementById('hintBox');
            hintBox.classList.toggle('visible');
            if (hintBox.classList.contains('visible')) {
                hintBox.style.animation = 'highlight 1s';
            }
        }

        function hasInvalidLetters(word) {
            const upper = word.toUpperCase();
            return upper.includes('I') || upper.includes('O');
        }

        function generateChoice() {
            const availablePairs = instrumentPairs.filter((p, i) => !usedPairs.includes(i));
            
            if (availablePairs.length === 0) {
                usedPairs = [];
            }

            const pair = availablePairs[Math.floor(Math.random() * availablePairs.length)];
            const pairIndex = instrumentPairs.indexOf(pair);
            usedPairs.push(pairIndex);

            const instruments = Math.random() > 0.5 
                ? [
                    { name: pair.valid, icon: pair.validIcon, valid: true },
                    { name: pair.invalid, icon: pair.invalidIcon, valid: false }
                  ]
                : [
                    { name: pair.invalid, icon: pair.invalidIcon, valid: false },
                    { name: pair.valid, icon: pair.validIcon, valid: true }
                  ];

            displayInstruments(instruments);
        }

        function displayInstruments(instruments) {
            const container = document.getElementById('instruments');
            container.innerHTML = '';

            instruments.forEach(inst => {
                const btn = document.createElement('div');
                btn.className = 'instrument-btn';
                btn.onclick = () => selectInstrument(inst.valid);
                btn.innerHTML = `
                    <div class="instrument-icon">${inst.icon}</div>
                    <div class="instrument-name">${inst.name}</div>
                `;
                container.appendChild(btn);
            });
        }

        function selectInstrument(isValid) {
            const msg = document.getElementById('message');

            if (isValid) {
                score++;
                document.getElementById('score').textContent = score;
                showMessage('Correcto Este instrumento puede entrar.', 'success');

                if (score >= 5) {
                    setTimeout(() => {
                        showMessage('Has descubierto el patron Has encontrado la cafeteria.', 'success');
                        document.getElementById('completeBtn').classList.remove('hidden');
                        document.getElementById('instruments').style.display = 'none';
                        document.getElementById('choiceText').style.display = 'none';
                    }, 1000);
                } else {
                    setTimeout(() => {
                        msg.classList.add('hidden');
                        generateChoice();
                    }, 1500);
                }
            } else {
                score = 0;
                mistakes++;
                document.getElementById('score').textContent = score;
                showMessage('Ese instrumento NO puede entrar. Contador reiniciado.', 'error');

                if (mistakes >= 3) {
                    const hintBox = document.getElementById('hintBox');
                    if (!hintBox.classList.contains('visible')) {
                        hintBox.classList.add('visible');
                        hintBox.style.animation = 'highlight 1s';
                    }
                }

                setTimeout(() => {
                    msg.classList.add('hidden');
                    usedPairs = [];
                    generateChoice();
                }, 2000);
            }
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.classList.remove('hidden');
        }

        function goBack() {
            window.location.href = '../../Escenarios/pasillo.html';
        }

        function completeAndGoBack() {
            localStorage.setItem('prueba3_1_2_3_completed', 'true');
            window.location.href = '../../Escenarios/pasillo.html';
        }

        generateChoice();
    </script>
</body>
</html>